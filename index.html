<!doctype html>
<meta charset="utf-8">
<title>Repo Explorer</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
  :root{--border:#e5e7eb;--muted:#6b7280;--bg:#fff}
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);
    font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP",sans-serif}
  .wrap{display:grid;grid-template-columns:300px 1fr;height:100vh}
  aside{border-right:1px solid var(--border);padding:12px;overflow:auto}
  main{height:100vh}
  #view{width:100%;height:100%;border:0;background:#fff}
  a.item{display:flex;gap:8px;align-items:center;color:#111;text-decoration:none;
    padding:6px 8px;border-radius:8px;outline:none}
  a.item:hover, a.item:focus{background:#f5f5f5}
  .muted{color:var(--muted);font-size:12px;margin:6px 8px}
  .top{display:flex;gap:8px;justify-content:space-between;align-items:center;margin-bottom:8px}
  .btn{padding:6px 10px;border:1px solid var(--border);border-radius:8px;background:#fff;cursor:pointer}
  .btn:hover{background:#f5f5f5}
  .disabled{opacity:.5;pointer-events:none}
</style>

<div class="wrap">
  <aside>
    <div class="top">
      <strong id="title">Contents</strong>
      <button id="openGitHub" class="btn">GitHub</button>
    </div>
    <div id="list" class="muted">Loading…</div>
  </aside>
  <main><iframe id="view" title="preview"></iframe></main>
</div>

<script>
(function(){
  const url=new URL(location.href);
  const qs=(k,d='')=>url.searchParams.get(k) ?? d;

  let owner=qs('owner')||'the-tsukasa';
  let repo=qs('repo')||'';
  const ref=qs('ref','main');
  let path=qs('path','');
  if(path==='/') path='';

  const $=(s)=>document.querySelector(s);
  const listBox=$('#list'),iframe=$('#view'),titleBox=$('#title'),btnGitHub=$('#openGitHub');

  // ---- repo 列表模式 ----
  async function listRepos(){
    titleBox.textContent=owner+"'s repositories";
    listBox.textContent='Loading…';
    try{
      const res=await fetch(`https://api.github.com/users/${owner}/repos?per_page=100`);
      const data=await res.json();
      if(!Array.isArray(data)){ listBox.textContent='Error'; return; }
      listBox.innerHTML='';
      data.sort((a,b)=>a.name.localeCompare(b.name));
      data.forEach(r=>{
        const a=document.createElement('a');
        a.className='item';
        a.textContent='📁 '+r.name;
        a.href=`?owner=${owner}&repo=${r.name}&ref=${ref}`;
        listBox.appendChild(a);
      });
    }catch(e){ listBox.textContent='异常：'+e; }
  }

  // ---- 文件浏览模式 ----
  async function listFiles(path=''){
    titleBox.textContent=`${owner}/${repo}`;
    listBox.textContent='Loading…';
    try{
      const res=await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${encodeURIComponent(path)}?ref=${ref}`);
      const data=await res.json();
      if(!Array.isArray(data)){ listBox.textContent='Error'; return; }
      listBox.innerHTML='';
      const dirs=data.filter(i=>i.type==='dir').sort((a,b)=>a.name.localeCompare(b.name));
      const files=data.filter(i=>i.type==='file').sort((a,b)=>a.name.localeCompare(b.name));
      [...dirs,...files].forEach(it=>{
        const a=document.createElement('a');
        a.className='item';
        a.textContent=(it.type==='dir'?'📁 ':'📄 ')+it.name;
        a.href='#';
        if(it.type==='dir'){
          a.onclick=(e)=>{e.preventDefault();listFiles(it.path);};
        }else{
          if(/^index\.html?$/i.test(it.name)){
            a.classList.add('disabled');
          }else{
            a.onclick=(e)=>{e.preventDefault();openPreview(it.path);};
          }
        }
        listBox.appendChild(a);
      });
    }catch(e){ listBox.textContent='异常：'+e; }
  }

  function openPreview(relPath){
    iframe.src=`https://${owner}.github.io/${repo}/${relPath}`;
  }

  // ---- 主入口 ----
  if(!repo){ // repo 列表模式
    btnGitHub.onclick=()=>window.open(`https://github.com/${owner}?tab=repositories`,'_blank');
    listRepos();
  }else{ // 文件浏览模式
    btnGitHub.onclick=()=>window.open(`https://github.com/${owner}/${repo}`,'_blank');
    listFiles(path);
  }
})();
</script>
